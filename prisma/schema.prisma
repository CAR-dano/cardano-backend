generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DB_URL")
}

model User {
  id                        String                @id
  email                     String?               @unique
  name                      String?
  googleId                  String?               @unique
  role                      Role                  @default(CUSTOMER)
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  password                  String?
  username                  String?               @unique
  walletAddress             String?               @unique
  pin                       String?               @unique
  refreshToken              String?               @unique
  whatsappNumber            String?               @map("whatsapp_number")
  inspectionBranchCityId    String?               @map("inspection_branch_city_id")
  isActive                  Boolean               @default(true) @map("is_active")
  credits                   Int                   @default(0)
  creditExpAt               DateTime?
  google_avatar_url         String?               @db.VarChar(512)
  profile_photo_storage_key String?               @db.VarChar(255)
  profile_photo_url         String                @default("") @db.VarChar(512)
  credit_consumptions       credit_consumptions[]
  customer_vehicles         customer_vehicles[]
  inspectionChangeLogs      InspectionChangeLog[]
  inspectionsSubmitted      Inspection[]          @relation("InspectedBy")
  inspectionsReviewed       Inspection[]          @relation("ReviewedBy")
  purchases                 purchases[]
  inspectionBranchCity      InspectionBranchCity? @relation(fields: [inspectionBranchCityId], references: [id])

  @@map("users")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Inspection {
  id                    String                @id @default(uuid())
  vehiclePlateNumber    String?               @db.VarChar(255)
  inspectionDate        DateTime?
  overallRating         String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  detailedAssessment    Json?
  equipmentChecklist    Json?
  identityDetails       Json?
  inspectionSummary     Json?
  vehicleData           Json?
  archivedAt            DateTime?             @map("archived_at")
  blockchainTxHash      String?               @unique @map("blockchain_tx_hash") @db.VarChar(255)
  deactivatedAt         DateTime?             @map("deactivated_at")
  inspectorId           String?               @map("inspector_id")
  nftAssetId            String?               @unique @map("nft_asset_id") @db.VarChar(255)
  pdfFileHash           String?               @map("pdf_file_hash") @db.VarChar(255)
  reviewerId            String?               @map("reviewer_id")
  status                InspectionStatus      @default(NEED_REVIEW)
  urlPdf                String?               @map("url_pdf") @db.VarChar(255)
  bodyPaintThickness    Json?
  pretty_id             String                @unique @map("pretty_id")
  notesFontSizes        Json?                 @default("{}") @map("notes_font_sizes")
  branchCityId          String?               @map("branch_city_id")
  ipfsPdf               String?               @map("ipfs_pdf") @db.VarChar(255)
  ipfsPdfNoDocs         String?               @map("ipfs_pdf_no_docs") @db.VarChar(255)
  pdfFileHashNoDocs     String?               @map("pdf_file_hash_no_docs") @db.VarChar(255)
  urlPdfNoDocs          String?               @map("url_pdf_no_docs") @db.VarChar(255)
  url_pdf_cloud         String?               @db.VarChar(255)
  url_pdf_no_docs_cloud String?               @db.VarChar(255)
  blockchain_queue      blockchain_queue[]
  credit_consumptions   credit_consumptions[]
  changeLogs            InspectionChangeLog[]
  photos                Photo[]
  branchCity            InspectionBranchCity? @relation("InspectionBranchRelation", fields: [branchCityId], references: [id])
  inspector             User?                 @relation("InspectedBy", fields: [inspectorId], references: [id])
  reviewer              User?                 @relation("ReviewedBy", fields: [reviewerId], references: [id])

  @@index([inspectorId])
  @@index([reviewerId])
  @@index([vehiclePlateNumber])
  @@index([status])
  @@index([createdAt])
  @@index([branchCityId, createdAt])
  @@index([identityDetails], map: "inspections_identity_details_gin_idx", type: Gin)
  @@index([vehicleData], map: "inspections_vehicle_data_gin_idx", type: Gin)
  @@map("inspections")
}

model Photo {
  id            String     @id @default(uuid())
  inspectionId  String
  path          String
  label         String?    @default("Tambahan")
  originalLabel String?
  needAttention Boolean?   @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  category      String?    @default("General")
  isMandatory   Boolean?   @default(false)
  displayInPdf  Boolean?   @default(true)
  inspection    Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@map("inspection_photos")
}

model InspectionBranchCity {
  id          String       @id @default(uuid())
  city        String       @unique
  code        String       @unique @db.VarChar(3)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  isActive    Boolean      @default(true) @map("is_active")
  inspections Inspection[] @relation("InspectionBranchRelation")
  users       User[]

  @@map("inspection_branch_city")
}

model InspectionChangeLog {
  id              String     @id @default(uuid())
  inspectionId    String
  changedByUserId String
  fieldName       String
  oldValue        Json?
  newValue        Json?
  changedAt       DateTime   @default(now())
  subFieldName    String?
  subsubfieldname String?
  changedByUser   User       @relation(fields: [changedByUserId], references: [id], onDelete: Cascade)
  inspection      Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([changedByUserId])
  @@map("inspection_change_logs")
}

model InspectionSequence {
  branchCode   String @db.VarChar(3)
  datePrefix   String @db.VarChar(8)
  nextSequence Int    @default(1)

  @@id([branchCode, datePrefix])
  @@map("inspection_sequences")
}

model BlacklistedToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(512)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("blacklisted_tokens")
}

model InspectionTarget {
  id          String       @id @default(uuid())
  targetValue Int
  period      TargetPeriod
  targetDate  DateTime     @db.Date
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([period, targetDate])
  @@map("inspection_targets")
}

model blockchain_queue {
  id            String               @id
  taskType      BlockchainTaskType
  payload       Json
  status        BlockchainTaskStatus @default(PENDING)
  attempts      Int                  @default(0)
  maxRetries    Int                  @default(3)
  lockedUtxos   String[]
  lastError     String?
  errorStack    String?
  processAt     DateTime             @default(now())
  startedAt     DateTime?
  completedAt   DateTime?
  resultTxHash  String?
  resultAssetId String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime
  inspectionId  String?
  inspections   Inspection?          @relation(fields: [inspectionId], references: [id])

  @@index([status, processAt])
  @@index([taskType, status])
}

model credit_consumptions {
  id           String     @id
  userId       String
  inspectionId String
  cost         Int        @default(1)
  usedAt       DateTime   @default(now())
  uniqueKey    String     @unique
  inspections  Inspection @relation(fields: [inspectionId], references: [id])
  users        User       @relation(fields: [userId], references: [id])

  @@index([userId, inspectionId])
}

model credit_packages {
  id          String      @id
  credits     Int
  price       Int
  discountPct Int
  benefits    Json?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  purchases   purchases[]

  @@index([isActive])
}

model customer_vehicle_photos {
  id                String            @id
  vehicle_id        String
  type              VehiclePhotoType
  label             String?           @db.VarChar(100)
  category          String?           @db.VarChar(100)
  path              String            @db.VarChar(255)
  storage_key       String?           @db.VarChar(255)
  content_type      String?           @db.VarChar(100)
  is_primary        Boolean           @default(false)
  display_order     Int               @default(0)
  created_at        DateTime          @default(now())
  updated_at        DateTime
  customer_vehicles customer_vehicles @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)

  @@index([vehicle_id])
}

model customer_vehicles {
  id                      String                    @id
  user_id                 String
  plate_number            String                    @db.VarChar(32)
  year                    Int
  transmission            VehicleTransmission
  vehicle_type            VehicleType
  brand                   String                    @db.VarChar(100)
  model                   String                    @db.VarChar(100)
  color                   String                    @db.VarChar(100)
  specification           String?
  service_history         String?
  created_at              DateTime                  @default(now())
  updated_at              DateTime
  customer_vehicle_photos customer_vehicle_photos[]
  users                   User                      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, plate_number])
  @@index([user_id])
}

model purchases {
  id              String          @id
  userId          String
  packageId       String
  gateway         PaymentGateway
  extInvoiceId    String          @unique
  amount          Int
  status          PurchaseStatus  @default(PENDING)
  createdAt       DateTime        @default(now())
  paidAt          DateTime?
  credit_packages credit_packages @relation(fields: [packageId], references: [id])
  users           User            @relation(fields: [userId], references: [id])

  @@index([userId, status, createdAt])
}

model utxo_locks {
  id          String   @id
  utxoKey     String   @unique
  lockedBy    String
  lockedAt    DateTime @default(now())
  expiresAt   DateTime
  txHash      String
  outputIndex Int
  amount      String
  address     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([expiresAt])
  @@index([lockedBy])
}

model webhook_events {
  id           String    @id
  gateway      String
  extInvoiceId String
  eventType    String?
  dedupeKey    String    @unique
  payloadHash  String?
  payload      Json?
  headers      Json?
  attempts     Int       @default(0)
  receivedAt   DateTime  @default(now())
  processedAt  DateTime?
  result       String?
  error        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime

  @@index([extInvoiceId, receivedAt])
  @@index([processedAt])
}

enum Role {
  ADMIN
  REVIEWER
  INSPECTOR
  CUSTOMER
  DEVELOPER
  SUPERADMIN
}

enum InspectionStatus {
  NEED_REVIEW
  APPROVED
  ARCHIVING
  ARCHIVED
  FAIL_ARCHIVE
  DEACTIVATED
}

enum TargetPeriod {
  YEAR
  MONTH
  WEEK
  DAY
}

enum BlockchainTaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum BlockchainTaskType {
  MINT_NFT
  BULK_MINT
  BURN_NFT
}

enum PaymentGateway {
  XENDIT
  MIDTRANS
}

enum PurchaseStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  REFUNDED
}

enum VehiclePhotoType {
  FRONT
  BACK
  LEFT
  RIGHT
  INTERIOR
  EXTERIOR
  ENGINE
  DOCUMENT
  OTHER
}

enum VehicleTransmission {
  MANUAL
  AUTOMATIC
}

enum VehicleType {
  SEDAN
  SUV
  HATCHBACK
  MPV
  TRUCK
  VAN
  MOTORCYCLE
  OTHER
}
